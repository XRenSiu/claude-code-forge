# 阶段 7：交叉验收 + 部署 (Verified Deployment)

> 独立验证部署结果，确保没有"部署成功但实际挂了"的情况

---

## 📋 阶段概述

| 维度 | 说明 |
|------|------|
| **目标** | 独立验证部署结果，确保没有"部署成功但实际挂了"的情况 |
| **输入** | 通过 P5 审查的代码 |
| **输出** | 部署完成 + 验证报告 |
| **上游阶段** | 对抗审查（阶段5，全部通过时） |
| **下游阶段** | 无（流水线终点） |

---

## 🧩 组件清单

| 类型 | 名称 | 模型 | 说明 |
|------|------|------|------|
| **Agent** | Deployer (general-purpose) | sonnet | 执行前置检查 + 部署 |
| **Agent** | Verifier (general-purpose) | sonnet | 独立验证部署结果 |
| **Skill** | — | — | 无专用 Skill（由 `forge-pipeline` 编排） |
| **Rule** | `team-coordination.md` | — | 团队协调通信规则 |

---

## 💡 为什么这样设计

### 单 Agent 部署的问题

单个 Agent 既部署又自检，存在系统性风险：

| 问题 | 英文名 | 表现 | 后果 |
|------|--------|------|------|
| 自验证偏差 | Self-Verification Bias | 部署者倾向于确认"一切正常" | 遗漏部署后的隐性故障 |
| 盲点复制 | Blind Spot Replication | 部署脚本有问题 → 自检也有同样盲点 | 系统性地错过某类故障 |
| 走过场 | Superficial Check | "没报错就是成功" → 不深入测试 | "部署成功但实际挂了" |

**现实世界类比**：

```
单 agent 部署 ≈ 厨师自己试吃自己的菜
                 "味道不错"
                 (因为他知道自己放了什么调料)

交叉验证    ≈ 厨师做菜 + 另一个人盲品
                 厨师: "部署完成，无错误"
                 品尝者: "首页 500 了，API 超时"
```

---

### 为什么独立验证者

验证者（Verifier）是一个完全独立的 Agent，它：

| 特性 | 效果 |
|------|------|
| 不知道部署细节 | 从用户视角测试，不被实现细节影响 |
| 独立运行测试 | 不依赖部署者的测试结果 |
| 对照 PRD 验收 | 检查功能完整性，不只是"没报错" |
| 不知道"哪些东西可能出问题" | 不会只检查部署者担心的地方 |

```
Deployer 的盲区：                    Verifier 的优势：
┌──────────────────────────┐       ┌──────────────────────────┐
│ "环境变量都配好了"        │       │ "让我试试 API 能不能用"   │
│ "数据库 migration 跑过了" │       │ "让我走一遍用户注册流程"  │
│ "服务启动没报错"          │       │ "让我检查响应时间"        │
│ "和上次部署步骤一样"      │       │ "让我测试边界情况"        │
└──────────────────────────┘       └──────────────────────────┘
      知道做了什么                        检查效果是什么
```

---

### 为什么交叉确认 (Cross-Confirmation)

**两方独立确认**，缺一不可：

```
┌─────────────────────────────────────────────────────────────┐
│                      交叉确认协议                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Deployer 确认:                                             │
│  ├── "部署过程无错误"                                        │
│  ├── "所有服务已启动"                                        │
│  └── "配置已应用"                                            │
│                                                             │
│  Verifier 确认:                                              │
│  ├── "健康检查通过"                                          │
│  ├── "冒烟测试通过"                                          │
│  ├── "用户流程可用"                                          │
│  └── "PRD 验收标准满足"                                      │
│                                                             │
│  ┌────────────────────────────┐                             │
│  │ 两方都确认 → ✅ 部署成功   │                              │
│  │ 任一方失败 → ❌ 自动回滚   │                              │
│  └────────────────────────────┘                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

这受到**"双人规则"（Two-Person Rule）**的启发——核武器发射需要两个独立操作员同时确认。重要操作需要独立确认，而非单方面自信。

| 确认模式 | 可靠性 | 类比 |
|---------|--------|------|
| 单方确认 | 低 | 一个人说"没问题" |
| 双方确认（知道对方结果） | 中 | 两个人商量后说"没问题" |
| 交叉确认（独立判断） | 高 | 两个人各自验证后同时说"没问题" |

---

### 为什么不用对抗模式

部署阶段与 P1/P2/P5/P6 有本质不同：

| 维度 | P1/P2/P5/P6（对抗） | P7（协作） |
|------|---------------------|-----------|
| 决策类型 | 主观判断（哪个方案更好？） | 客观验证（是否成功？） |
| 辩论价值 | 高（多视角提升决策质量） | 低（成功/失败是客观事实） |
| 角色关系 | 对立（挑战者 vs 被挑战者） | 互补（执行者 + 验证者） |
| 目标 | 找到最优解 | 确认无故障 |

```
协作模式光谱：

  对抗辩论          协作+审查          并行协作
  ◄──────────────────────────────────────────────────►
  P1 P2 P5 P6      P3 P7 ◀── 部署在这里  P4
  适合主观判断       适合验证型任务      适合可分解任务
```

部署不需要辩论"哪种部署方式更好"——它需要的是"执行 + 独立验证"的协作模式。

---

### 关键设计决策

| 决策 | 选项 A | 选项 B | 选择 | 原因 |
|------|--------|--------|------|------|
| 模式 | 对抗辩论 | 协作验证 | 协作 | 部署是执行 + 验证，无需辩论 |
| 验证者 | 无（Deployer 自检） | 独立 Verifier | 有 | 独立验证防止自验证偏差 |
| 回滚策略 | 手动回滚 | 自动回滚 | 自动 | 任一方确认失败立即回滚，速度更快 |
| 前置检查 | 可选 | 强制 | 强制 | 前置检查比回滚便宜 10 倍 |
| 模型选择 | opus | sonnet | sonnet | 部署是执行任务，不需要高级推理 |
| 生产环境 | 自动 | 需人工确认 | 需人工确认 | 生产环境影响真实用户 |

---

## 🔧 组件详解

### Deployer (general-purpose agent)

**职责**：前置检查 + 部署执行 + 部署确认

#### 前置检查清单 (Pre-Deployment Checklist)

```
┌─────────────────────────────────────────────────────────────┐
│  Pre-Deployment Checklist                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [ ] 1. 所有测试通过                                         │
│         └── npm test / pytest / go test                      │
│                                                              │
│  [ ] 2. 构建成功                                             │
│         └── npm run build / make build                       │
│                                                              │
│  [ ] 3. 安全审计通过                                         │
│         └── npm audit / safety check                         │
│                                                              │
│  [ ] 4. 覆盖率达标                                           │
│         └── 1→100: >= 80% | 0→1: >= 50%                     │
│                                                              │
│  [ ] 5. 无未提交的更改                                       │
│         └── git status (clean)                               │
│                                                              │
│  [ ] 6. 分支已合并或 PR 已批准                                │
│         └── git log / gh pr view                             │
│                                                              │
│  [ ] 7. 环境变量已配置                                       │
│         └── 检查 .env.example vs 目标环境                     │
│                                                              │
│  任一项未通过 → 停止部署，报告给 Lead                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 部署执行

| 步骤 | 操作 | 失败处理 |
|------|------|---------|
| 1. 运行前置检查 | 检查清单 7 项 | 报告未通过项，停止 |
| 2. 生产环境人工确认 | 通知 Lead 等待用户确认 | 用户拒绝 → 停止 |
| 3. 执行部署命令 | 平台特定命令 | 记录错误，报告 |
| 4. 等待部署完成 | 监控部署状态 | 超时 → 报告 |
| 5. 基础健康检查 | 服务是否启动 | 立即回滚 |
| 6. 向 Lead 报告 | 部署状态确认 | — |

#### 支持的部署目标

| 平台 | 部署方式 | 适用场景 |
|------|---------|---------|
| Vercel | MCP / CLI | 前端 / Serverless |
| Railway | MCP / CLI | 后端服务 |
| Cloudflare | MCP / CLI | Workers / Pages |
| Docker | Bash | 容器化部署 |
| 自定义脚本 | Bash | 任何其他环境 |

---

### Verifier (general-purpose agent)

**职责**：独立验证部署结果

#### 验证清单

```
┌─────────────────────────────────────────────────────────────┐
│  Post-Deployment Verification Checklist                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 健康检查 (Health Checks)                                 │
│     [ ] HTTP 200 on /health or /healthz                     │
│     [ ] 响应时间 < 阈值                                      │
│     [ ] 所有依赖服务可达                                      │
│                                                              │
│  2. 冒烟测试 (Smoke Tests)                                   │
│     [ ] 核心 API 端点可用                                     │
│     [ ] 数据库读写正常                                        │
│     [ ] 缓存层正常                                            │
│     [ ] 认证/授权流程正常                                     │
│                                                              │
│  3. 用户流程验证 (User Flow Validation)                       │
│     [ ] 关键用户场景端到端通过                                 │
│     [ ] 页面正常加载（无 500/404）                             │
│     [ ] 表单提交正常                                          │
│                                                              │
│  4. PRD 验收标准 (PRD Acceptance Criteria)                    │
│     [ ] 逐条检查 PRD 中的验收标准                              │
│     [ ] 功能行为符合预期                                      │
│     [ ] 边缘情况已覆盖                                        │
│                                                              │
│  任一关键项未通过 → 报告给 Lead → 触发回滚                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 验证方法

| 验证类型 | 方法 | 工具 |
|---------|------|------|
| 健康检查 | HTTP 请求 | curl / Bash |
| API 冒烟 | 调用核心端点 | curl / Bash |
| 用户流程 | 模拟用户操作 | Bash / 日志检查 |
| PRD 对照 | 阅读 PRD + 逐条验证 | Read + Bash |
| 性能基线 | 响应时间对比 | Bash 时间测量 |

---

## 🚀 使用流程

### 典型部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                    P7 部署流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  前置检查 (Deployer)                                        │
│  ├── 测试通过？ ──[否]──▶ 停止，报告                         │
│  ├── 构建成功？ ──[否]──▶ 停止，报告                         │
│  ├── 安全审计？ ──[否]──▶ 停止，报告                         │
│  └── 全部通过                                               │
│       │                                                     │
│       ▼                                                     │
│  人工确认 (生产环境)                                         │
│  ├── 用户确认 ──[拒绝]──▶ 停止                              │
│  └── 确认通过                                               │
│       │                                                     │
│       ▼                                                     │
│  部署执行 (Deployer)                                        │
│  └── 执行部署命令                                           │
│       │                                                     │
│       ▼                                                     │
│  独立验证 (Verifier)                                         │
│  ├── 健康检查                                               │
│  ├── 冒烟测试                                               │
│  ├── 用户流程验证                                           │
│  └── PRD 验收标准检查                                       │
│       │                                                     │
│       ▼                                                     │
│  交叉确认                                                   │
│  ├── Deployer: "部署完成，无错误" ──┐                       │
│  │                                  ├── 双方确认             │
│  ├── Verifier: "验证通过，功能正常"─┘                       │
│  │       │                                                  │
│  │       ▼                                                  │
│  │  ✅ 部署成功 → 通知 Lead → 流水线结束                     │
│  │                                                          │
│  └── 任一方失败                                             │
│         │                                                   │
│         ▼                                                   │
│    ❌ 自动回滚 → 通知 Lead → 排查问题                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 命令示例

```bash
# 流水线中由 P5 全部通过后自动进入
/forge-teams --phase 7

# 指定部署目标
/forge-teams --phase 7 --platform vercel

# 模拟部署（不实际执行）
/forge-teams --phase 7 --dry-run
```

### 回滚流程

```
验证失败
    │
    ▼
Deployer 执行回滚
    ├── Vercel: vercel rollback
    ├── Railway: railway rollback
    ├── Docker: docker rollback
    └── 自定义: 执行 rollback 脚本
    │
    ▼
Verifier 验证回滚后的状态
    ├── 通过 → 旧版本恢复正常
    └── 失败 → 紧急通知人工介入
```

---

## ⚙️ vs pdforge 对比

| 维度 | pdforge (deployer) | forge-teams (P7) | 价值 |
|------|-------------------|------------------|------|
| 验证方式 | Deployer 自验证 | 独立 Verifier 验证 | 防止自验证偏差 |
| 确认模式 | 单方确认 | 交叉确认（双方独立） | 双重保险 |
| 回滚 | 手动触发 | 自动（任一方失败即回滚） | 更快的故障恢复 |
| 前置检查 | 有（测试 + 安全扫描） | 有（更全面的 7 项清单） | 预防优于回滚 |
| PRD 对照 | 无 | Verifier 逐条对照 PRD | 确保功能完整性 |
| 人工确认 | 生产环境需要 | 生产环境需要 | 一致 |
| Token | 1x | ~2x | 部署安全性值得 |
| 文档更新 | doc-updater agent | Lead 协调（复用 pdforge 工具） | — |

### 简化场景对比

| 场景 | pdforge 处理 | forge-teams 处理 |
|------|-------------|-----------------|
| Staging 部署 | deploy → 自检 | deploy → 独立验证 |
| Production 部署 | deploy → 自检 → 人工确认 | deploy → 独立验证 → 交叉确认 → 人工确认 |
| 部署失败 | 手动回滚 | 自动回滚 + 回滚后再验证 |
| 部分功能故障 | 可能被自检遗漏 | Verifier 走用户流程时发现 |

---

## ⚠️ 注意事项

### 必须遵守

1. **前置检查不可跳过**：所有测试和审计必须通过后才能部署——前置检查比回滚便宜 10 倍
2. **交叉确认是硬要求**：单方确认不足以认定部署成功——Deployer 说"没报错"不代表"功能正常"
3. **回滚优先**：任何验证失败优先回滚，不尝试在线修复——在线修复容易引入更多问题
4. **人工确认**：生产环境部署前需要人类最终确认——影响真实用户的操作必须有人签字
5. **验证独立性**：Verifier 不能依赖 Deployer 的测试结果——独立验证才有意义

### 反模式列表

| 反模式 | 症状 | 正确做法 |
|--------|------|---------|
| 跳过前置检查 | "测试之前跑过了" | 每次部署前都重新运行 |
| Deployer 自检替代 Verifier | "部署完我自己检查就行" | 必须由独立 Verifier 验证 |
| 忽略 Verifier 报告 | "可能是验证环境问题" | 任何验证失败都要回滚后排查 |
| 在线修复 | "改一下配置就好了" | 回滚 → 修复 → 重新部署 |
| 跳过人工确认 | "staging 测过了，直接上生产" | 生产环境永远需要人工确认 |
| 不验证回滚 | "回滚就行了" | 回滚后也要验证旧版本正常 |
| Verifier 只做健康检查 | "/ 返回 200 就行" | 还要走用户流程 + PRD 对照 |

### 交叉确认矩阵

```
                Verifier 通过    Verifier 失败
Deployer 通过   ✅ 部署成功       ❌ 回滚（功能问题）
Deployer 失败   ❌ 回滚（部署问题） ❌ 回滚（严重问题）
```

只有左上角（双方都通过）才算部署成功。其他三种情况都触发回滚。

---

## 🔗 下一阶段

无。P7 是流水线终点。

```
┌─────────────────────────────────────────────────────────────┐
│                      完整流水线回顾                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  P1: 对抗需求分析  → PRD                                    │
│       │                                                     │
│       ▼                                                     │
│  P2: 对抗架构设计  → ADR                                    │
│       │                                                     │
│       ▼                                                     │
│  P3: 规划 + 风险   → Plan                                   │
│       │                                                     │
│       ▼                                                     │
│  P4: 并行实现      → Code                                   │
│       │                                                     │
│       ▼                                                     │
│  P5: 对抗审查      → Review Report                          │
│       │                                                     │
│       ├──[有问题]──▶ P6: 对抗调试 → Fix → 回到 P5           │
│       │                                                     │
│       └──[通过]────▶ P7: 交叉验收 + 部署 ◀── 你在这里        │
│                           │                                 │
│                           ▼                                 │
│                      ✅ 流水线完成                            │
│                           │                                 │
│                           ▼                                 │
│                      新功能开发 → 回到 P1                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 完成后可选操作

```bash
# 更新文档（复用 pdforge 的能力）
/update-docs

# 提取学习（复用 pdforge 的能力）
/learn

# 开始新功能开发
/forge-teams "新功能需求描述"
```
