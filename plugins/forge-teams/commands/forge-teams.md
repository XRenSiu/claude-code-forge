---
description: Agent Teams 版 7 阶段产品开发流水线。对抗辩论 + 并行实现 + 红队审查 + 对抗调试。
argument-hint: <requirement> [--phase <1-7>] [--skip-to <phase>] [--team-size <small|medium|large>]
---

## Mission

`/forge-teams` 是 Agent Teams 驱动的产品开发主协调器。它将 pdforge 的 7 阶段流水线升级为多 agent 对抗协作模式：每个关键决策点由多个 agent 并行竞争、辩论和交叉验证，确保产出质量远超单 agent 线性推理。

---

## 用法

```bash
/forge-teams <requirement> [options]
```

---

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `<requirement>` | 需求描述（文本或文件路径） | 必填 |
| `--phase <1-7>` | 仅运行指定阶段 | 运行全部 |
| `--skip-to <phase>` | 从指定阶段恢复（需要前序产物） | 从阶段 1 开始 |
| `--team-size <size>` | 团队规模配置 | `medium` |
| `--no-red-team` | 跳过红队审查（阶段 5） | 启用红队 |
| `--fix` | 修复阶段 5/6 发现的问题 | 不自动修复 |
| `--loop [N]` | 修复后重新验证（最多 N 轮） | 3 |

---

## 7 阶段流水线

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    FORGE-TEAMS 对抗协作流水线                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段 1: 需求对抗辩论                                                     │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ 需求输入      │──▶│ 乐观分析师 vs 悲观分析师 vs 用户  │──▶ PRD     │
│  └──────────────┘    │ 代言人 → 辩论 → 共识 PRD         │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 2: 架构竞标                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ PRD          │──▶│ 架构师 A vs 架构师 B vs 评审团    │──▶ ADR     │
│  └──────────────┘    │ 竞标方案 → 评审 → 最优架构        │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 3: 任务规划                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ ADR          │──▶│ 规划师 + 风险分析师               │──▶ Plan    │
│  └──────────────┘    │ 规划 → 风险审查 → 修正            │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 4: 并行实现                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ Plan         │──▶│ 实现者 A ∥ 实现者 B ∥ TDD 守卫   │──▶ Code    │
│  └──────────────┘    │ 并行编码 + TDD 执法               │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 5: 红队审查                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ Code + PRD   │──▶│ 红队攻击者 vs 蓝队防御者          │──▶ Report  │
│  └──────────────┘    │ 攻击 → 防御 → 仲裁               │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 6: 对抗调试                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ Report       │──▶│ 假设竞争 + Devil's Advocate       │──▶ Fixes   │
│  └──────────────┘    │ 对抗式根因分析 + TDD 修复          │              │
│         │            └──────────────────────────────────┘              │
│         ▼                                                              │
│  阶段 7: 交付验收                                                        │
│  ┌──────────────┐    ┌──────────────────────────────────┐              │
│  │ Fixed Code   │──▶│ 交叉验收 + 文档更新               │──▶ Deploy  │
│  └──────────────┘    │ 多 agent 交叉验收 → 部署           │              │
│                      └──────────────────────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 示例

### 完整流水线

```bash
# 从需求开始完整对抗协作流程
/forge-teams "用户认证功能，支持 OAuth2 和 JWT"

# 大团队模式 + 自动修复循环
/forge-teams "支付系统重构" --team-size large --fix --loop 5
```

### 单阶段执行

```bash
# 只执行需求对抗辩论
/forge-teams "暗色模式切换" --phase 1

# 只执行红队审查
/forge-teams --phase 5
```

### 从中间恢复

```bash
# 已有 PRD 和 ADR，从阶段 3 开始
/forge-teams --skip-to 3

# 已有代码，从红队审查开始
/forge-teams --skip-to 5
```

---

## 团队规模配置

| 规模 | 每阶段团队 | 适用场景 | Token 消耗 |
|------|-----------|---------|-----------|
| `small` | 2-3 agents | 小功能、快速验证 | 中 |
| `medium` | 3-5 agents | 标准功能开发 | 高 |
| `large` | 5-7 agents | 复杂功能、高质量要求 | 很高 |

### 各阶段团队组成（medium 配置）

| 阶段 | 角色 | 数量 |
|------|------|------|
| 1. 需求辩论 | 乐观分析师 + 悲观分析师 + 用户代言人 + 仲裁者 | 4 |
| 2. 架构竞标 | 架构师 A + 架构师 B + 评审团 | 3 |
| 3. 任务规划 | 规划师 + 风险分析师 | 2 |
| 4. 并行实现 | 实现者 x2 + TDD 守卫 | 3 |
| 5. 红队审查 | 红队 x2 + 蓝队 x1 + 仲裁者 | 4 |
| 6. 对抗调试 | 调查员 x2 + Devil's Advocate + 综合员 | 4 |
| 7. 交付验收 | 验收员 x2 + 文档更新员 | 3 |

---

## Token 消耗警告

> **注意**: forge-teams 使用 Agent Teams 进行多 agent 并行协作，token 消耗远高于 pdforge。
>
> | 模式 | 预估 Token 消耗（相对 pdforge） |
> |------|-------------------------------|
> | small | 3-5x |
> | medium | 5-10x |
> | large | 10-20x |
>
> 建议先用 pdforge 验证流程可行性，再用 forge-teams 进行高质量保证。

---

## 前置条件

1. **启用 Agent Teams 实验性功能**:

```json
// settings.json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

2. **安装 forge-teams 插件**（本插件）

---

## 与 pdforge 命令的互补关系

forge-teams 是 pdforge 的 Agent Teams 升级版，两者可以互补使用：

| 场景 | 推荐 |
|------|------|
| 快速原型验证 | `/pdforge --mode 0to1` |
| 标准功能开发 | `/pdforge --fix --loop` |
| 高质量要求的核心功能 | `/forge-teams --team-size medium` |
| 安全关键功能 | `/forge-teams --team-size large` |
| 只需对抗调试 | `/adversarial-debugging` |
| 只需需求辩论 | `/forge-teams --phase 1` |

---

## 输出目录结构

```
docs/forge-teams/
└── [feature]-[timestamp]/
    ├── phase-1-requirements/
    │   ├── debate-transcript.md     # 需求辩论记录
    │   └── prd.md                   # 共识 PRD
    ├── phase-2-architecture/
    │   ├── proposal-a.md            # 架构方案 A
    │   ├── proposal-b.md            # 架构方案 B
    │   ├── evaluation.md            # 评审记录
    │   └── adr.md                   # 最终 ADR
    ├── phase-3-planning/
    │   ├── plan.json                # 任务计划
    │   └── risk-assessment.md       # 风险评估
    ├── phase-4-implementation/
    │   └── report.md                # 实现报告
    ├── phase-5-red-team/
    │   ├── attack-report.md         # 红队攻击报告
    │   ├── defense-report.md        # 蓝队防御报告
    │   └── arbitration.md           # 仲裁结果
    ├── phase-6-debugging/
    │   ├── hypotheses.md            # 假设列表
    │   ├── debate-log.md            # 调试辩论记录
    │   └── fixes.md                 # 修复记录
    ├── phase-7-delivery/
    │   └── acceptance.md            # 交叉验收报告
    └── summary.md                   # 最终流水线摘要
```
