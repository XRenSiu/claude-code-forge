---
description: 修复构建和类型错误。快速解决编译错误、TypeScript 类型问题和构建失败，使用最小改动原则。
argument-hint: [--error <error-message>] [--file <file-path>] [--strict]
---

## Mission

快速修复构建错误和类型问题。使用最小改动原则，专注于解决编译和类型检查失败。

---

## 语法

```bash
/build-fix [options]
```

## 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `--error` | string | 否 | 具体的错误信息 |
| `--file` | string | 否 | 错误所在的文件路径 |
| `--strict` | flag | 否 | 严格模式，不允许类型断言等妥协 |
| `--check-only` | flag | 否 | 仅检查不修复 |

---

## 使用示例

### 自动检测并修复

```bash
/build-fix
```

运行构建命令，自动检测并修复所有错误。

### 修复特定错误

```bash
/build-fix --error "Property 'name' does not exist on type 'User'"
```

针对特定错误进行修复。

### 修复特定文件

```bash
/build-fix --file src/auth/login.ts
```

仅检查并修复指定文件的错误。

### 严格模式

```bash
/build-fix --strict
```

不使用 `any`、类型断言等妥协方案。

---

## 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    /build-fix 执行流程                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────────────────────────────────────────┐         │
│   │                  检测阶段                          │         │
│   │  • 运行构建命令 (npm run build / tsc)             │         │
│   │  • 收集所有错误                                   │         │
│   │  • 按文件和行号分组                               │         │
│   └───────────────────────┬───────────────────────────┘         │
│                           │                                     │
│                           ▼                                     │
│   ┌───────────────────────────────────────────────────┐         │
│   │                  分析阶段                          │         │
│   │  • 识别错误类型                                   │         │
│   │  • 确定根因                                       │         │
│   │  • 计划最小修复                                   │         │
│   └───────────────────────┬───────────────────────────┘         │
│                           │                                     │
│                           ▼                                     │
│   ┌───────────────────────────────────────────────────┐         │
│   │                  修复阶段                          │         │
│   │  对每个错误:                                      │         │
│   │  • 应用最小修复                                   │         │
│   │  • 验证修复                                       │         │
│   │  • 检查是否引入新错误                             │         │
│   └───────────────────────┬───────────────────────────┘         │
│                           │                                     │
│                           ▼                                     │
│   ┌───────────────────────────────────────────────────┐         │
│   │                  验证阶段                          │         │
│   │  • 重新运行构建                                   │         │
│   │  • 确认所有错误已修复                             │         │
│   │  • 运行测试确认无回归                             │         │
│   └───────────────────────────────────────────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 常见错误类型和修复策略

| 错误类型 | 示例 | 修复策略 |
|----------|------|----------|
| 缺失属性 | `Property 'x' does not exist` | 添加属性到类型定义 |
| 类型不匹配 | `Type 'A' is not assignable to 'B'` | 修复类型或添加类型转换 |
| 导入错误 | `Cannot find module` | 修复导入路径或安装依赖 |
| 缺失返回类型 | `Function lacks ending return` | 添加返回语句或修改类型 |
| 未使用变量 | `'x' is declared but never used` | 移除或添加使用 |
| 空值检查 | `Object is possibly null` | 添加空值检查或断言 |

---

## 最小改动原则

修复时遵循以下优先级：

1. **修复类型定义** - 最优先，不改变运行时行为
2. **添加类型注解** - 帮助编译器理解意图
3. **修复逻辑错误** - 如缺失返回语句
4. **添加空值检查** - 防御性编程
5. **类型断言** - 最后手段（`--strict` 模式禁用）

**禁止**：
- 使用 `@ts-ignore` 注释
- 使用 `any` 类型（`--strict` 模式）
- 删除类型检查相关配置

---

## 输出格式

### 检测到错误

```
🔧 构建错误检测
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 发现 5 个构建错误:

1. src/auth/login.ts:42
   Property 'email' does not exist on type 'User'

2. src/auth/login.ts:58
   Type 'string | undefined' is not assignable to type 'string'

3. src/models/user.ts:15
   'password' is declared but its value is never read

4. src/utils/validators.ts:23
   Function lacks ending return statement

5. src/api/routes.ts:89
   Cannot find module './handlers'

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔧 正在修复...
```

### 修复完成

```
✅ 构建错误已修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 修复摘要:
├── 错误总数: 5
├── 已修复: 5
├── 无法修复: 0
└── 新增错误: 0

📁 修改的文件:
├── src/auth/login.ts
│   ├── L42: 添加 email 属性到 User 类型
│   └── L58: 添加空值检查
├── src/models/user.ts
│   └── L15: 移除未使用的变量
├── src/utils/validators.ts
│   └── L23: 添加返回语句
└── src/api/routes.ts
    └── L89: 修复导入路径

✅ 构建成功
✅ 测试通过 (42/42)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 与其他命令的关系

| 命令 | 说明 |
|------|------|
| `/tdd` | TDD 开发，可能产生构建错误 |
| `/build-fix` | 修复构建错误 |
| `/fix` | 修复审查发现的问题 |
| `/accept` | 验收审查 |

---

## 最佳实践

1. **先运行 /build-fix**：在提交前确保构建通过
2. **使用 --strict**：避免类型妥协
3. **检查测试**：修复后运行测试确认无回归
4. **理解错误**：不要盲目修复，理解根因

---

## 注意事项

⚠️ **自动修复的局限性**：

- 自动修复适合简单的类型错误
- 复杂的架构问题需要人工分析
- 某些错误可能需要设计决策

⚠️ **避免过度妥协**：

- 不要用 `any` 掩盖问题
- 不要用 `@ts-ignore` 绕过检查
- 类型断言应是最后手段
