---
description: 完整的 7 阶段产品开发自动化流水线。从想法到部署，协调需求分析、系统设计、任务规划、开发实现、质量审查、修复验证和交付部署。
argument-hint: [--from-idea|--from-prd|--from-design|--from-plan] [--fix] [--loop [N]] [--skip-review] [--skip-deploy] [--mode 0to1|1to100] [--brainstorm] <input>
---

## Mission

PDForge 是 AI 驱动产品开发的主协调器。它将想法转化为生产就绪、经过审查的代码，通过结构化的 7 阶段流水线实现。

---

## 7 阶段流水线

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        PDFORGE 完整流水线                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段 1: 需求分析                                                        │
│  ┌─────────────────┐                                                    │
│  │  想法/需求       │──▶ brainstorming ──▶ prd-generator ──▶ PRD       │
│  └─────────────────┘                                                    │
│           │                                                             │
│           ▼                                                             │
│  阶段 2: 系统设计                                                        │
│  ┌─────────────────┐                                                    │
│  │  PRD            │──▶ architect ──▶ ADR + 架构文档                   │
│  └─────────────────┘                                                    │
│           │                                                             │
│           ▼                                                             │
│  阶段 3: 任务规划                                                        │
│  ┌─────────────────┐                                                    │
│  │  设计文档        │──▶ planner ──▶ 任务分解 + 依赖关系               │
│  └─────────────────┘                                                    │
│           │                                                             │
│           ▼                                                             │
│  阶段 4: 开发实现                                                        │
│  ┌─────────────────┐                                                    │
│  │  任务计划        │──▶ implementer ──▶ 生产级代码 + 测试             │
│  │                 │    (per task)      tdd-guide                      │
│  └─────────────────┘                                                    │
│           │                                                             │
│           ▼                                                             │
│  阶段 5: 质量审查                                                        │
│  ┌─────────────────┐    ┌─────────────────────────────────┐             │
│  │  代码 + PRD     │──▶ │ /accept                         │             │
│  │                 │    │ --fix --loop                    │             │
│  └─────────────────┘    └─────────────────────────────────┘             │
│           │                    │                                        │
│           │    ┌───────────────┼───────────────┐                        │
│           │    ▼               ▼               ▼                        │
│           │  spec-reviewer  code-reviewer  security-reviewer            │
│           │    │               │               │                        │
│           │    └───────────────┼───────────────┘                        │
│           │                    ▼                                        │
│           │              issue-fixer                                    │
│           │                    │                                        │
│           │                    ▼                                        │
│           │         (循环直到全部通过)                                   │
│           │                                                             │
│           ▼                                                             │
│  阶段 6: 修复验证                                                        │
│  ┌─────────────────┐                                                    │
│  │  审查反馈        │──▶ issue-fixer ──▶ 系统性修复                    │
│  │                 │    systematic-debugging                           │
│  └─────────────────┘                                                    │
│           │                                                             │
│           ▼                                                             │
│  阶段 7: 交付部署                                                        │
│  ┌─────────────────┐                                                    │
│  │  ✅ 审查通过     │──▶ deployer ──▶ 准备提交/合并                    │
│  │  ✅ 测试通过     │    doc-updater                                   │
│  │  ✅ 修复完成     │                                                  │
│  └─────────────────┘                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 使用模式

### 完整流水线（想法 → 部署）

```bash
# 从简短想法开始
/pdforge --from-idea "添加用户认证功能，支持 OAuth2 和 JWT"

# 从需求文件开始
/pdforge --from-idea docs/ideas/payment-v2.md

# 带自动修复和验证循环
/pdforge --from-idea "暗色模式切换" --fix --loop

# 指定产品模式
/pdforge --from-idea "MVP 登录功能" --mode 0to1
/pdforge --from-idea "支付系统重构" --mode 1to100
```

### 部分流水线（从某阶段恢复）

```bash
# 已有 PRD，从阶段 2 开始
/pdforge --from-prd docs/prd/auth-prd.md

# 已有设计文档，从阶段 3 开始
/pdforge --from-design docs/adr/auth-adr.md

# 已有计划，从阶段 4 开始
/pdforge --from-plan docs/plans/auth-plan.json

# 只运行验收审查
/pdforge --accept-only docs/prd/auth-prd.md src/auth/
```

---

## 选项

| 标志 | 说明 |
|------|------|
| `--from-idea` | 从需求/想法开始（运行完整流水线） |
| `--from-prd` | 从现有 PRD 开始（跳过阶段 1） |
| `--from-design` | 从现有设计文档开始（跳过阶段 1-2） |
| `--from-plan` | 从现有计划开始（跳过阶段 1-3） |
| `--accept-only` | 仅对现有代码运行验收审查 |
| `--fix` | 自动修复验收中发现的问题 |
| `--loop [N]` | 修复后重新验证（默认 3 轮） |
| `--skip-review` | 跳过验收阶段，仅实现 |
| `--skip-deploy` | 跳过部署阶段 |
| `--mode 0to1` | 0→1 产品模式（MVP/创业） |
| `--mode 1to100` | 1→100 产品模式（成熟产品，默认） |
| `--brainstorm` | 启用 brainstorming 需求澄清（仅与 `--from-idea` 搭配使用，默认不启用） |
| `--spec` / `--code` / `--security` | 选择特定审查员 |
| `--output <dir>` | 产物输出目录 |
| `--feature <name>` | 功能名（用于文件命名） |

---

## 产品模式配置

### 0→1 产品（MVP/创业）

```yaml
tdd_coverage: 50%              # 较低覆盖率
review: code_only              # 仅代码审查
security_review: optional      # 可选安全审查
adr: optional                  # 可选 ADR
max_fix_rounds: 2              # 较少修复轮数
execution_mode: executing-plans # 快速执行
```

### 1→100 产品（成熟产品）

```yaml
tdd_coverage: 80%              # 高覆盖率
review: full                   # 完整三阶段审查
security_review: required      # 必须安全审查
adr: mandatory                 # 强制 ADR
max_fix_rounds: 5              # 更多修复轮数
execution_mode: subagent-driven-development # 高质量执行
```

> **Brainstorming** 不与产品模式绑定。使用 `--brainstorm` 参数显式启用，两种模式下行为完全一致（完整 6 阶段流程）。

---

## 执行流程

### 阶段 0: 初始化

```
╔═══════════════════════════════════════════════════════════════════╗
║ 🚀 PDForge 流水线已初始化                                          ║
╠═══════════════════════════════════════════════════════════════════╣
║                                                                   ║
║ 功能: [name]                                                      ║
║ 模式: [from-idea | from-prd | from-design | from-plan]           ║
║ 产品阶段: [0→1 | 1→100]                                           ║
║ 输入: [源文件或内联]                                               ║
║                                                                   ║
║ 流水线阶段:                                                       ║
║   [✅/⏭️] 1. 需求分析 (brainstorming + PRD)                       ║
║   [✅/⏭️] 2. 系统设计 (architect + ADR)                           ║
║   [✅/⏭️] 3. 任务规划 (planner)                                   ║
║   [✅/⏭️] 4. 开发实现 (implementer + TDD)                         ║
║   [✅/⏭️] 5. 质量审查 (/accept)                                   ║
║   [✅/⏭️] 6. 修复验证 (issue-fixer)                               ║
║   [✅/⏭️] 7. 交付部署 (deployer + doc-updater)                    ║
║                                                                   ║
║ 输出目录: docs/pdforge/[feature]-[timestamp]/                     ║
║                                                                   ║
╚═══════════════════════════════════════════════════════════════════╝
```

### 阶段 1: 需求分析（如 --from-idea）

**调用**: `brainstorming` skill（如 `--brainstorm`）→ `prd-generator` agent

```
┌─────────────────────────────────────────────────────────────────┐
│ 📄 阶段 1: 需求分析                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 输入: [想法/需求描述]                                            │
│                                                                 │
│ ⏳ [--brainstorm] 启动苏格拉底式问答...                         │
│    └── 生成设计文档                                             │
│                                                                 │
│ ⏳ 分析代码库...                                                │
│ ⏳ 提取需求...                                                  │
│ ⏳ 生成 PRD...                                                  │
│ ⏳ 质量验证 (13 项检查)...                                      │
│                                                                 │
│ ✅ PRD 已生成                                                   │
│    └── 输出: docs/pdforge/[feature]/prd.md                      │
│    └── 质量: 12/13 检查通过                                     │
│    └── User Stories: 5                                          │
│    └── 需求: 12 (P0: 4, P1: 5, P2: 3)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 2: 系统设计

**调用**: `architect` agent

```
┌─────────────────────────────────────────────────────────────────┐
│ 🏗️ 阶段 2: 系统设计                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 输入: [阶段 1 的 PRD 或 --from-prd]                             │
│                                                                 │
│ ⏳ 分析架构约束...                                              │
│ ⏳ 评估技术选型...                                              │
│ ⏳ 设计系统架构...                                              │
│ ⏳ 生成 ADR...                                                  │
│                                                                 │
│ ✅ 设计完成                                                     │
│    └── 输出: docs/pdforge/[feature]/adr.md                      │
│    └── 架构决策: 4                                              │
│    └── 组件: 6                                                  │
│    └── 集成点: 3                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 3: 任务规划

**调用**: `planner` agent

```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 阶段 3: 任务规划                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 输入: [阶段 2 的设计文档或 --from-design]                       │
│                                                                 │
│ ⏳ 分析需求...                                                  │
│ ⏳ 检测技术栈...                                                │
│ ⏳ 生成任务分解...                                              │
│ ⏳ 分析复杂度...                                                │
│ ⏳ 映射依赖关系...                                              │
│                                                                 │
│ ✅ 计划已生成                                                   │
│    └── 输出: docs/pdforge/[feature]/plan.json                   │
│    └── 任务: 8 个                                               │
│    └── 复杂度: 低(2), 中(4), 高(2)                             │
│    └── 关键路径: 12 小时                                        │
│                                                                 │
│ 任务概览:                                                       │
│   1. [基础] 项目设置 (⬜ 2/10)                                  │
│   2. [基础] 数据库 Schema (⬜ 4/10)                             │
│   3. [核心] Auth 服务 (⬜ 7/10)                                 │
│   4. [核心] 用户管理 (⬜ 6/10)                                  │
│   5. [集成] API 路由 (⬜ 5/10)                                  │
│   6. [前端] Auth 组件 (⬜ 6/10)                                 │
│   7. [质量] 单元测试 (⬜ 4/10)                                  │
│   8. [收尾] 文档 (⬜ 2/10)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 4: 开发实现

**调用**: `implementer` agent（按任务，遵循依赖顺序）+ `tdd-guide` agent

```
┌─────────────────────────────────────────────────────────────────┐
│ 🔧 阶段 4: 开发实现                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 按依赖顺序执行任务...                                           │
│                                                                 │
│ 任务 1/8: 项目设置                                              │
│   ⏳ 架构分析...                                                │
│   ⏳ 实现中...                                                  │
│   ✅ 完成 (3 个文件创建)                                        │
│                                                                 │
│ 任务 2/8: 数据库 Schema                                         │
│   ⏳ 架构分析...                                                │
│   ⏳ 实现中...                                                  │
│   ✅ 完成 (2 个文件创建, 1 个修改)                              │
│                                                                 │
│ 任务 3/8: Auth 服务                                             │
│   ⏳ 架构分析...                                                │
│   ⏳ TDD: 编写测试（红色）...                                   │
│   ⏳ TDD: 实现代码（绿色）...                                   │
│   ⏳ TDD: 重构...                                               │
│   ✅ 完成 (8 个文件创建)                                        │
│                                                                 │
│ [... 剩余任务 ...]                                              │
│                                                                 │
│ ✅ 实现完成                                                     │
│    └── 文件创建: 24                                             │
│    └── 文件修改: 6                                              │
│    └── 新增行数: +1,842                                         │
│    └── 测试覆盖率: 82%                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 5: 质量审查

**调用**: `/accept` 命令（带所有审查员）

```
┌─────────────────────────────────────────────────────────────────┐
│ 🎯 阶段 5: 质量审查                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 规格: docs/pdforge/[feature]/prd.md                             │
│ 审查员: 规格 ✅ | 代码 ✅ | 安全 ✅                              │
│                                                                 │
│ Round 1/3:                                                      │
│   🔍 规格审查...                                                │
│      └── 结论: 🟡 部分通过                                      │
│      └── 问题: 2 blocker, 3 important                           │
│                                                                 │
│   🔍 代码审查...                                                │
│      └── 结论: 🟡 需修改后通过                                  │
│      └── 问题: 1 blocker, 4 important                           │
│                                                                 │
│   🔍 安全审查...                                                │
│      └── 结论: 🟢 安全                                          │
│      └── 问题: 0 blocker, 2 important                           │
│                                                                 │
│ 汇总: 3 blocker, 9 important, 5 minor                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 6: 修复验证（如 --fix --loop）

**调用**: `issue-fixer` agent → `/accept` 命令（循环）

```
┌─────────────────────────────────────────────────────────────────┐
│ 🔧 阶段 6: 修复验证                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 🔧 修复 3 个 blocker...                                         │
│    └── #1: 缺少输入验证 ✅                                      │
│    └── #2: 登录流程中断 ✅                                      │
│    └── #3: 认证绕过漏洞 ✅                                      │
│                                                                 │
│ 🔧 修复 9 个 important...                                       │
│    └── [8 已修复, 1 阻塞]                                       │
│                                                                 │
│ 📊 修复摘要:                                                    │
│    └── 已修复: 11                                               │
│    └── 阻塞: 1 (需数据库迁移)                                   │
│    └── 跳过: 5 (minor)                                          │
│                                                                 │
│ 🔄 重新验证 (Round 2/3)...                                      │
│    └── 规格: 🟢 通过                                            │
│    └── 代码: 🟢 通过                                            │
│    └── 安全: 🟢 通过                                            │
│                                                                 │
│ ✅ 所有问题已解决！                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段 7: 交付部署

**调用**: `deployer` agent（可选）+ `doc-updater` agent

```
┌─────────────────────────────────────────────────────────────────┐
│ 🚀 阶段 7: 交付部署                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 📝 更新文档...                                                  │
│    └── README.md ✅                                             │
│    └── API 文档 ✅                                              │
│    └── CHANGELOG.md ✅                                          │
│                                                                 │
│ 🚀 部署准备...                                                  │
│    └── 环境: [staging / production / skip]                      │
│    └── 状态: ✅ 就绪                                            │
│                                                                 │
│ ✅ 交付完成                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 最终摘要

```
╔═══════════════════════════════════════════════════════════════════╗
║ 🎉 PDForge 流水线完成                                              ║
╠═══════════════════════════════════════════════════════════════════╣
║                                                                   ║
║ 功能: user-auth                                                   ║
║ 耗时: 45 分钟                                                     ║
║ 状态: ✅ 可以合并                                                 ║
║                                                                   ║
║ ┌─────────────────────────────────────────────────────────────┐   ║
║ │ 流水线结果                                                  │   ║
║ ├─────────────────────────────────────────────────────────────┤   ║
║ │ 需求分析:     ✅ 12/13 质量检查                             │   ║
║ │ 系统设计:     ✅ 4 个架构决策                               │   ║
║ │ 任务规划:     ✅ 8 个任务, 12h 关键路径                     │   ║
║ │ 开发实现:     ✅ 24 文件, +1,842 行                         │   ║
║ │ 质量审查:     ✅ 所有审查员通过                             │   ║
║ │ 修复验证:     ✅ 11 个问题已解决                            │   ║
║ │ 交付部署:     ✅ 文档已更新                                 │   ║
║ └─────────────────────────────────────────────────────────────┘   ║
║                                                                   ║
║ 产物:                                                             ║
║   📄 PRD:      docs/pdforge/user-auth-20250124/prd.md             ║
║   🏗️ ADR:      docs/pdforge/user-auth-20250124/adr.md             ║
║   📋 计划:     docs/pdforge/user-auth-20250124/plan.json          ║
║   📊 审查:     docs/pdforge/user-auth-20250124/acceptance/        ║
║   📝 摘要:     docs/pdforge/user-auth-20250124/summary.md         ║
║                                                                   ║
║ 🚀 下一步:                                                        ║
║   1. 查看摘要: docs/pdforge/user-auth-20250124/summary.md         ║
║   2. 提交变更: git add -A && git commit -m "feat: ..."            ║
║   3. 创建 PR 或合并到 main                                        ║
║                                                                   ║
╚═══════════════════════════════════════════════════════════════════╝
```

---

## 协调逻辑

```
1. 解析输入并确定流水线模式
2. 创建会话目录: docs/pdforge/[feature]-[timestamp]/

IF --from-idea:
    3a. [--brainstorm] 调用 brainstorming skill
    3b. 调用 prd-generator 生成 PRD
    3c. 保存 PRD 到会话目录
    3d. 继续到步骤 4

IF --from-prd:
    3. 加载现有 PRD
    继续到步骤 4

4. 调用 architect 进行系统设计
5. 保存 ADR 到会话目录

IF --from-design:
    3-5. 加载现有设计文档
    继续到步骤 6

6. 调用 planner 生成任务计划
7. 保存计划到会话目录

IF --from-plan:
    3-7. 加载现有计划
    继续到步骤 8

8. FOR 每个任务按依赖顺序:
    8a. 调用 implementer 执行任务
    8b. 调用 tdd-guide 确保 TDD 流程
    8c. 追踪进度和创建的文件

IF NOT --skip-review:
    9. 调用 /accept 带 PRD 作为规格
       - 如指定则传递 --fix
       - 如指定则传递 --loop N

    10. 如有问题且 --fix:
        调用 issue-fixer 进行修复
        循环验证

11. IF NOT --skip-deploy:
    调用 deployer（可选）
    调用 doc-updater 更新文档

12. 生成最终摘要报告
13. 显示完成状态
```

---

## 错误处理

**如 PRD 生成失败**：
```
❌ PRD 生成失败

原因: [错误详情]

选项:
  1. 提供更详细的需求
  2. 手动创建 PRD: docs/pdforge/[feature]/prd.md
  3. 恢复: /pdforge --from-prd docs/pdforge/[feature]/prd.md
```

**如某任务实现失败**：
```
❌ 任务 3 实现失败

任务: Auth 服务
错误: [错误详情]

选项:
  1. 重试任务: /pdforge --retry-task 3
  2. 跳过任务: /pdforge --skip-task 3 --from-plan [plan]
  3. 手动修复后恢复
```

**如验收审查阻塞**：
```
⚠️ 验收审查被阻塞

断路器在 3 轮后触发。
剩余问题需要人工干预:
  - 问题 #4: 需要数据库 schema 变更
  - 问题 #7: 需要外部 API 集成

需要手动处理后才能继续。
```

---

## 与现有命令的集成

PDForge 封装现有命令：
- 阶段 1 使用 `/brainstorm` 和 `prd-generator` agent
- 阶段 2 使用 `architect` agent 和 `/design`
- 阶段 3 使用 `planner` agent 和 `/plan`
- 阶段 4 使用 `implementer` 和 `tdd-guide` agent
- 阶段 5-6 使用 `/accept` 命令（调用 spec-reviewer, code-reviewer, security-reviewer, issue-fixer）
- 阶段 7 使用 `/deploy` 和 `/update-docs`

这允许：
- 使用单独命令进行细粒度控制
- 使用 /pdforge 进行完整自动化
- 混合手动和自动化阶段

---

## 典型工作流

**全新功能**：
```bash
/pdforge --from-idea "用户认证 with OAuth2" --brainstorm --fix --loop
```

**基于现有 PRD 迭代**：
```bash
/pdforge --from-prd docs/prd/auth-v2.md --fix --loop
```

**快速实现（跳过审查）**：
```bash
/pdforge --from-idea "添加暗色模式" --skip-review
```

**仅运行验收审查**：
```bash
/pdforge --accept-only docs/prd/feature.md src/ --fix --loop 5
```

**MVP 模式**：
```bash
/pdforge --from-idea "MVP 登录功能" --mode 0to1 --fix --loop 2
```

**成熟产品模式**：
```bash
/pdforge --from-idea "支付系统重构" --mode 1to100 --fix --loop 5
```

---

## 输出目录结构

```
docs/pdforge/
└── [feature]-[timestamp]/
    ├── prd.md                  # 生成的 PRD
    ├── design-doc.md           # 设计文档（如有 brainstorming）
    ├── adr.md                  # 架构决策记录
    ├── plan.json               # 开发计划（JSON）
    ├── plan.md                 # 开发计划（Markdown）
    ├── implementation/
    │   └── report.md           # 实现报告
    ├── acceptance/
    │   ├── .accept_session.json
    │   ├── round-1-review.md
    │   ├── round-1-fixes.md
    │   ├── round-2-review.md
    │   └── summary.md
    └── summary.md              # 最终流水线摘要
```

---

## 注意事项

⚠️ **资源消耗**：
- 完整流水线会调用多个 Agent，注意 token 消耗
- MVP 模式 (0→1) 消耗较少，适合快速验证
- 成熟模式 (1→100) 消耗较多，适合重要功能

⚠️ **时间预期**：
- 完整流水线可能需要较长时间
- 可使用部分流水线加速迭代
- 断路器会在卡住时自动停止

⚠️ **人工干预点**：
- 需求澄清（brainstorming 阶段）
- 架构决策（design 阶段）
- 被阻塞的问题（accept 阶段）
- 部署审批（deploy 阶段）
