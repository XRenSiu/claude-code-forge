---
description: 启动测试驱动开发模式。执行 TDD 红-绿-重构循环，确保没有失败的测试就没有代码。
argument-hint: [--plan <plan-file>] [--task <task-id>] [--coverage <percent>] [--strict]
---

## Mission

启动测试驱动开发（TDD）模式。严格执行红-绿-重构循环，确保所有代码都有对应的测试先行。

---

## TDD 铁律

**核心原则**：没有失败的测试，就没有代码。

```
┌─────────────────────────────────────────────────────────────────┐
│                    TDD 红-绿-重构循环                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│     ┌──────────────────────────────────────────────────┐        │
│     │                                                  │        │
│     │    1. 🔴 红色: 写一个失败的测试                  │        │
│     │       └── 运行测试，确认失败                     │        │
│     │                                                  │        │
│     │              ↓                                   │        │
│     │                                                  │        │
│     │    2. 🟢 绿色: 写最小代码让测试通过              │        │
│     │       └── 运行测试，确认通过                     │        │
│     │                                                  │        │
│     │              ↓                                   │        │
│     │                                                  │        │
│     │    3. 🔵 重构: 改进代码质量                      │        │
│     │       └── 运行测试，确认仍然通过                 │        │
│     │                                                  │        │
│     │              ↓                                   │        │
│     │                                                  │        │
│     │    返回步骤 1，下一个测试                        │        │
│     │                                                  │        │
│     └──────────────────────────────────────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 语法

```bash
/tdd [options]
```

## 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `--plan` | string | 否 | 任务计划文件路径 |
| `--task` | string | 否 | 特定任务 ID |
| `--coverage` | number | 否 | 最低覆盖率要求（默认 80%） |
| `--strict` | flag | 否 | 严格模式，任何违规立即停止 |
| `--mode` | string | 否 | `subagent`（高质量）或 `fast`（快速） |

---

## 使用示例

### 基本 TDD 模式

```bash
/tdd
```

启动 TDD 模式，交互式开发。

### 从计划执行

```bash
/tdd --plan docs/plans/auth-plan.json
```

按计划中的任务顺序执行 TDD 开发。

### 执行特定任务

```bash
/tdd --plan docs/plans/auth-plan.json --task 3
```

仅执行计划中的任务 3。

### 高质量模式

```bash
/tdd --plan docs/plans/auth-plan.json --mode subagent
```

使用子代理驱动开发，每个任务独立审查。

### 快速模式（MVP）

```bash
/tdd --plan docs/plans/auth-plan.json --mode fast --coverage 50
```

快速执行，较低覆盖率要求。

---

## 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    /tdd 执行流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────────────────────────────────────────┐         │
│   │                  初始化                            │         │
│   │  • 加载计划（如有）                               │         │
│   │  • 设置覆盖率目标                                 │         │
│   │  • 检测测试框架                                   │         │
│   └───────────────────────┬───────────────────────────┘         │
│                           │                                     │
│                           ▼                                     │
│   ┌───────────────────────────────────────────────────┐         │
│   │              对每个任务/功能                       │         │
│   │                                                   │         │
│   │  1️⃣ 🔴 红色阶段                                   │         │
│   │     ├── 分析需求                                  │         │
│   │     ├── 编写测试用例                              │         │
│   │     ├── 运行测试                                  │         │
│   │     └── 确认失败 ❌                               │         │
│   │                                                   │         │
│   │  2️⃣ 🟢 绿色阶段                                   │         │
│   │     ├── 编写最小实现代码                          │         │
│   │     ├── 运行测试                                  │         │
│   │     └── 确认通过 ✅                               │         │
│   │                                                   │         │
│   │  3️⃣ 🔵 重构阶段                                   │         │
│   │     ├── 改进代码质量                              │         │
│   │     ├── 运行测试                                  │         │
│   │     └── 确认仍然通过 ✅                           │         │
│   │                                                   │         │
│   │  4️⃣ 验证覆盖率                                    │         │
│   │     └── 是否达到目标?                             │         │
│   │         ├── 是 → 继续下一个任务                   │         │
│   │         └── 否 → 添加更多测试                     │         │
│   └───────────────────────┬───────────────────────────┘         │
│                           │                                     │
│                           ▼                                     │
│   ┌───────────────────────────────────────────────────┐         │
│   │              完成检查                              │         │
│   │  • 最终覆盖率报告                                 │         │
│   │  • 测试摘要                                       │         │
│   │  • 下一步建议                                     │         │
│   └───────────────────────────────────────────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 反合理化红旗

| AI 借口 | 正确回应 |
|---------|----------|
| 「我已经手动测试过了」 | 删除代码，重新用 TDD |
| 「先写代码再补测试也一样」 | 不一样，TDD 驱动设计 |
| 「这个太简单不需要测试」 | 简单的更容易测试 |
| 「我之后会加测试」 | 不行，现在就加 |
| 「这只是小改动」 | 同样的 TDD 流程 |
| 「测试会拖慢开发」 | 缺陷修复更慢 |

**违规处理**（`--strict` 模式）：
- 检测到先写代码 → 立即删除代码
- 测试未运行就写实现 → 警告并回滚
- 覆盖率不达标 → 阻止提交

---

## 输出格式

### TDD 进行中

```
🔴 TDD 开发模式
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 任务: 用户登录功能
📊 目标覆盖率: 80%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 红色阶段: 编写测试
├── 测试用例: should authenticate user with valid credentials
├── 文件: src/auth/login.test.ts
├── 运行测试...
└── ❌ 测试失败（预期）

🟢 绿色阶段: 实现代码
├── 文件: src/auth/login.ts
├── 运行测试...
└── ✅ 测试通过

🔵 重构阶段: 改进代码
├── 提取 validateCredentials 函数
├── 运行测试...
└── ✅ 测试仍然通过

📊 当前覆盖率: 75% (目标 80%)
└── 需要更多测试...

🔴 红色阶段: 编写测试
├── 测试用例: should reject invalid password
├── ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### TDD 完成

```
✅ TDD 开发完成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 任务: 用户登录功能
📊 最终覆盖率: 85% ✅

📈 测试摘要:
├── 测试用例: 12
├── 通过: 12
├── 失败: 0
├── 跳过: 0
└── 耗时: 2.3s

📁 创建/修改的文件:
├── src/auth/login.ts (新建)
├── src/auth/login.test.ts (新建)
├── src/auth/types.ts (新建)
└── src/auth/validators.ts (新建)

🚀 下一步:
├── 运行完整测试套件: npm test
├── 检查覆盖率报告: npm run coverage
└── 提交代码: git commit

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 与其他命令的关系

| 命令 | 说明 |
|------|------|
| `/plan` | 生成任务计划，可被 /tdd 消费 |
| `/tdd` | 执行 TDD 开发 |
| `/build-fix` | 修复构建错误 |
| `/accept` | 验收审查 |
| `/pdforge` | 完整流水线（包含 /tdd） |

---

## 最佳实践

1. **小步前进**：每次只写一个测试用例
2. **最小实现**：只写让测试通过的最少代码
3. **频繁重构**：每次绿色后都考虑重构机会
4. **命名规范**：测试名应描述行为，如 `should_authenticate_user_with_valid_credentials`
5. **隔离测试**：每个测试独立，不依赖执行顺序
6. **边界测试**：测试正常情况、边界情况和错误情况

---

## 注意事项

⚠️ **TDD 不是银弹**：
- TDD 驱动设计，但需要先理解需求
- 复杂算法可能需要先探索再 TDD
- UI 测试可能需要不同策略

⚠️ **测试质量**：
- 避免测试实现细节
- 测试行为而非方法
- 不要为了覆盖率而写无意义的测试
